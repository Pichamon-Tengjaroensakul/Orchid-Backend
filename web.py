# -*- coding: utf-8 -*-
"""web

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jmVvhF0P0bjtQsoTRzcq-PRNTruKvQ1Q
"""

# test_model_directly.py
import pandas as pd
import numpy as np
import joblib
import re

# --- ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏• ---
artifacts = joblib.load("orchid_decision_tree_v1.pkl")
model = artifacts["model"]
le = artifacts["label_encoder"]

# --- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• test ---
df = pd.read_excel("df_test.xlsx")
print("Test file shape:", df.shape)

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Colab ‡πÅ‡∏•‡∏∞ web.py ---
def find_tf_pairs(columns):
    pairs = []
    for col in columns:
        m = re.match(r"^(.*)T(\d+)$", col)
        if m:
            prefix, rep = m.group(1), m.group(2)
            t_col = col
            f_col = f"{prefix}F{rep}"
            if f_col in columns:
                pairs.append((t_col, f_col))
    return pairs

def extract_peak_features(t, f):
    mask = ~np.isnan(t) & ~np.isnan(f)
    t, f = np.asarray(t[mask]), np.asarray(f[mask])
    if len(t) < 3: return np.nan, np.nan, np.nan, np.nan
    sort_idx = np.argsort(t)
    t, f = t[sort_idx], f[sort_idx]
    peak_idx = np.argmax(f)
    F_peak = float(f[peak_idx])
    T_peak = float(t[peak_idx])
    area = float(np.trapz(f, t))
    half = F_peak / 2.0
    above_half = np.where(f >= half)[0]
    width = float(t[above_half[-1]] - t[above_half[0]]) if len(above_half) >= 2 else np.nan
    return T_peak, F_peak, width, area

# --- ‡∏î‡∏∂‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
tf_pairs = find_tf_pairs(df.columns)
all_features = []
sample_ids = []

for t_col, f_col in tf_pairs:
    t_vals = df[t_col].values
    f_vals = df[f_col].values
    T_peak, F_peak, width, area = extract_peak_features(t_vals, f_vals)
    if not np.isnan(T_peak):
        all_features.append([T_peak, F_peak, width, area])
        sample_ids.append(t_col)

X_test = np.array(all_features)
print(f"Extracted {len(all_features)} samples")

# --- ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ ---
probs = model.predict_proba(X_test)
avg_probs = np.mean(probs, axis=0)  # ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏ß‡πá‡∏ö: ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å sample ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

# --- ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Top 4 ---
top_indices = np.argsort(avg_probs)[::-1][:4]
print("\nüß™ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ (‡∏à‡∏≤‡∏Å‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á):")
for rank, idx in enumerate(top_indices, 1):
    species = le.inverse_transform([model.classes_[idx]])[0]
    conf = int(round(avg_probs[idx] * 100))
    print(f"{rank}. {species} ({conf}%)")