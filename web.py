# -*- coding: utf-8 -*-
"""web.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1RlkudOCWdhQo_1Wce8KJHy--lUJsggjt
"""

from fastapi import FastAPI, File, UploadFile, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import uvicorn
import pandas as pd
import numpy as np
import joblib
import os
import re
import io

app = FastAPI()

# ==========================================
# 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ CORS (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Lovable/Vercel)
# ==========================================
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏£‡∏∞‡∏ö‡∏∏‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ)
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ==========================================
# 2. ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•
# ==========================================
MODEL_PATH = os.path.join(os.path.dirname(__file__), 'orchid_model_final.pkl')
model_data = None

try:
    if os.path.exists(MODEL_PATH):
        model_data = joblib.load(MODEL_PATH)
        print("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!")
    else:
        print(f"‚ùå ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏ó‡∏µ‡πà: {MODEL_PATH}")
except Exception as e:
    print(f"‚ùå Error loading model: {e}")

# ==========================================
# 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Feature (Logic ‡πÄ‡∏î‡∏¥‡∏°)
# ==========================================
def extract_peak_features(t, f):
    try:
        mask = ~np.isnan(t) & ~np.isnan(f)
        t, f = np.asarray(t[mask]), np.asarray(f[mask])

        if len(t) < 3: return np.nan, np.nan, np.nan, np.nan

        sort_idx = np.argsort(t)
        t, f = t[sort_idx], f[sort_idx]

        peak_idx = np.argmax(f)
        F_peak = float(f[peak_idx])
        T_peak = float(t[peak_idx])

        if hasattr(np, 'trapezoid'): area = float(np.trapezoid(f, x=t))
        else: area = float(np.trapz(f, t))

        half = F_peak / 2.0
        above_half = np.where(f >= half)[0]
        if len(above_half) >= 2:
            width = float(t[above_half[-1]] - t[above_half[0]])
        else: width = np.nan

        return T_peak, F_peak, width, area
    except:
        return np.nan, np.nan, np.nan, np.nan

# ==========================================
# 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á API Endpoints
# ==========================================
@app.get("/")
def home():
    return {"message": "Orchid AI Backend (FastAPI) is Running! üöÄ"}

@app.post("/api/predict")
async def predict(file: UploadFile = File(...)):
    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏¥‡∏î‡πÑ‡∏´‡∏°
    if not model_data:
        raise HTTPException(status_code=500, detail="Model not loaded on server")

    # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå (Optional)
    if not file.filename.endswith(('.xlsx', '.xls')):
        raise HTTPException(status_code=400, detail="Invalid file format. Please upload .xlsx file")

    try:
        # ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå (FastAPI ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô Bytes ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡∏î‡πâ‡∏ß‡∏¢ io.BytesIO)
        contents = await file.read()
        df = pd.read_excel(io.BytesIO(contents))

        results = []
        columns = df.columns.tolist()
        processed_pairs = set()

        for col in columns:
            m = re.match(r"^(.*)T(\d+)$", str(col))
            if m:
                prefix, num = m.group(1), m.group(2)
                f_col = f"{prefix}F{num}"

                if f_col in columns and col not in processed_pairs:
                    processed_pairs.add(col)

                    t_vals = pd.to_numeric(df[col], errors='coerce').values
                    f_vals = pd.to_numeric(df[f_col], errors='coerce').values

                    T_peak, F_peak, width, area = extract_peak_features(t_vals, f_vals)

                    if not np.isnan(T_peak):
                        features = pd.DataFrame([[T_peak, F_peak, width, area]],
                                              columns=["T_peak", "F_peak", "Width_FWHM", "Area"])

                        pred_idx = model_data["model"].predict(features)[0]
                        pred_name = model_data["label_encoder"].inverse_transform([pred_idx])[0]

                        results.append({
                            "sample_id": f"{prefix}-{num}",
                            "T_peak": round(T_peak, 2),
                            "F_peak": round(F_peak, 4),
                            "predicted_species": pred_name
                        })

        return {"success": True, "results": results}

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ô‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤ deploy ‡∏ö‡∏ô Render ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ Render ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á start)
if __name__ == '__main__':
    port = int(os.environ.get('PORT', 8000))
    uvicorn.run(app, host='0.0.0.0', port=port)