# -*- coding: utf-8 -*-
"""web.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1BL6rGfcjRjgT-hPDLiIJHgnvx2CM4R33
"""

from fastapi import FastAPI, UploadFile, File
from fastapi.middleware.cors import CORSMiddleware
import pandas as pd
import numpy as np
import joblib
import re
import io

app = FastAPI()

# --- 1. ตั้งค่า CORS ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- 2. โหลดโมเดล AI ---
# ตรวจสอบให้แน่ใจว่าไฟล์ .pkl อยู่ใน Folder เดียวกัน
artifacts = joblib.load("orchid_decision_tree_v1.pkl")
model = artifacts["model"]
le = artifacts["label_encoder"]
medians = artifacts["medians"]
feat_cols = artifacts["feature_columns"]

# --- 3. สูตรคณิตศาสตร์หา Peak (เหมือนเดิม) ---
def extract_peak_features(t, f):
    mask = ~np.isnan(t) & ~np.isnan(f)
    t = np.asarray(t[mask])
    f = np.asarray(f[mask])

    if len(t) < 3:
        return np.nan, np.nan, np.nan, np.nan

    sort_idx = np.argsort(t)
    t = t[sort_idx]
    f = f[sort_idx]

    peak_idx = np.argmax(f)
    F_peak = float(f[peak_idx])
    T_peak = float(t[peak_idx])
    area = float(np.trapz(f, t))

    half = F_peak / 2.0
    above_half = np.where(f >= half)[0]
    if len(above_half) >= 2:
        width = float(t[above_half[-1]] - t[above_half[0]])
    else:
        width = np.nan

    return T_peak, F_peak, width, area

# --- 4. ฟังก์ชันเตรียมข้อมูล (ปรับปรุงใหม่: จับคู่ตามชื่อที่คล้ายกัน) ---
def process_file(df):
    columns = df.columns.tolist()
    pairs = []

    # วนลูปดูชื่อทุกคอลัมน์เพื่อหาตัว T (Temperature)
    # Regex: ^(.*)T(\d+)$ แปลว่า "อะไรก็ได้ข้างหน้า" ตามด้วย "T" ตามด้วย "ตัวเลข"
    for col in columns:
        match = re.match(r"^(.*)T(\d+)$", col)
        if match:
            prefix = match.group(1) # เช่น "Ptanalba" หรือ "" (ถ้าชื่อแค่ T1)
            number = match.group(2) # เช่น "1"

            # สร้างชื่อคู่ F ที่ควรจะเป็น
            # เช่นถ้าเจอ PtanalbaT1 ก็จะหา PtanalbaF1
            expected_f_col = f"{prefix}F{number}"

            # ถ้ามีคอลัมน์ F คู่กันอยู่จริง ให้จับคู่เลย
            if expected_f_col in columns:
                pairs.append((col, expected_f_col))

    # ถ้าไม่เจอคู่เลย ลองใช้วิธีสำรอง (เผื่อชื่อเป็น T1, F1 แบบไม่มี prefix)
    if not pairs:
         for col in columns:
             if col.startswith("T") and col[1:].isdigit():
                 f_col = "F" + col[1:]
                 if f_col in columns:
                     pairs.append((col, f_col))

    features = []
    for t_col, f_col in pairs:
        # แปลงข้อมูลเป็นตัวเลข (กัน error)
        t_vals = pd.to_numeric(df[t_col], errors='coerce').values
        f_vals = pd.to_numeric(df[f_col], errors='coerce').values

        # คำนวณ
        T_peak, F_peak, width, area = extract_peak_features(t_vals, f_vals)

        # ใช้ชื่อคอลัมน์ (ตัดคำว่า T/F ออก) เป็นชื่อ Sample ID
        # เช่น PtanalbaT1 -> Sample: Ptanalba1
        sample_name = t_col.replace("T", "").replace("F", "")
        # หรือจะใช้ชื่อเต็มๆ ก็ได้: sample_name = t_col

        features.append({
            "sample_id": sample_name,
            "T_peak": T_peak,
            "F_peak": F_peak,
            "Width_FWHM": width,
            "Area": area
        })

    feat_df = pd.DataFrame(features)

    # เติมค่า Missing Value (ถ้ามี)
    if not feat_df.empty:
        for col in feat_cols:
            if col not in feat_df.columns: # กันเหนียว
                feat_df[col] = np.nan
            feat_df[col] = feat_df[col].astype(float)
            if col in medians:
                feat_df[col] = feat_df[col].fillna(medians[col])

    return feat_df

# --- 5. API Endpoint ---
@app.post("/predict")
async def predict(file: UploadFile = File(...)):
    try:
        contents = await file.read()
        df = pd.read_excel(io.BytesIO(contents))

        processed_df = process_file(df)

        if processed_df.empty:
            return {"error": "ไม่พบคู่คอลัมน์ T และ F ที่ถูกต้อง (เช่น PtanalbaT1 คู่กับ PtanalbaF1)"}

        # ตรวจสอบว่าคำนวณค่า Feature ได้จริงไหม
        if processed_df["T_peak"].isnull().all():
             return {"error": "ข้อมูลมีปัญหา ไม่สามารถหาจุดยอดกราฟ (Peak) ได้"}

        X = processed_df[feat_cols].to_numpy()

        predictions = model.predict(X)
        probabilities = model.predict_proba(X)

        results = []
        for i, pred_idx in enumerate(predictions):
            species_name = le.inverse_transform([pred_idx])[0]
            confidence = float(np.max(probabilities[i]))
            confidence_percent = round(confidence * 100, 2)

            results.append({
                "sample_id": str(processed_df.iloc[i]["sample_id"]), # แปลงเป็น string ให้ชัวร์
                "species": species_name,
                "confidence": confidence_percent
            })

        return {"results": results}

    except Exception as e:
        return {"error": f"Server Error: {str(e)}"}